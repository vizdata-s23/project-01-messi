---
output: html_document
editor_options: 
  chunk_output_type: console
---
### Load Packages

```{r}
#| label: load-pkgs
#| message: false
#| warning: false

library(tidyverse)
library(ggplot2)
```

### Load Data

```{r}
#| label: load-data
#| message: false

wcmatches <- readr::read_csv('https://raw.githubusercontent.com/rfordatascience/tidytuesday/master/data/2022/2022-11-29/wcmatches.csv')
worldcups <- readr::read_csv('https://raw.githubusercontent.com/rfordatascience/tidytuesday/master/data/2022/2022-11-29/worldcups.csv')
penalties <- readr::read_csv("data/penalties_stats_aa.csv") #external data from kaggle
```

#### Merge Data

```{r, echo = FALSE}
#| label: merge-data

world_cup_total <- wcmatches |>
  left_join(worldcups, by = "year")

world_cup_total <- penalties %>%
  select(-Host) %>%
  rename('year' = "Year") %>%
left_join(world_cup_total, penalties, by = 'year')
```

#### New Variables

```{r, echo = FALSE}
#| label: new-variables
world_cup_total <- world_cup_total |>
  mutate(goalspergame = goals_scored/games,
         attendancepergame = attendance/games,
         gamesperteam = games/teams)
```

## Question 1

**scatterplot showing the number of goals scored per game of each world cup**

**x-axis will be `year` and the y-axis will be the average `goals_scored` per game of that world cup**.

**annotations on top of this graph to show when certain changes were implemented in the World Cup**,

**may add another variable such as continent (color) in order to see if the if the power rankings across the world have shifted over time**

```{r, echo = FALSE}
#| label: q1-plot1
world_cup_total %>%
  add_row(year = 1942, goalspergame = 0, country = "Germany") %>%
  add_row(year = 1946, goalspergame = 0, country = "Brazil") %>%
  mutate(new_rule = case_when(year %in% c(1970, 1982, 1998, 2014, 2018) ~ "Yes",
                              TRUE ~ "No"),
         event = case_when(year %in% c(1942, 1946, 1954, 1966, 1978) ~ "Yes",
                           TRUE ~ "No")) %>%
  group_by(year, goalspergame) %>%
  ggplot(aes(x = year, 
             y = goalspergame, 
             color = new_rule, 
             shape = event)) +
  geom_point(size = 2) +
  scale_x_continuous(breaks = seq(1930, 2018, by=8)) +
  theme_minimal() +
  scale_color_manual(values = c("#A80040", "#75A9CF")) +
  scale_shape_manual(values = c(16, 8)) +
  labs(title = "Goals per Game",
       subtitle = "For World Cups 1930-2018",
       x = "Year",
       y = "Goals per game",
       color = "New rule implemented",
       shape = "Notable event") +
  annotate(geom = "text",
           label = "1942, 1946: cancelled \ndue to WWII",
           x = 1944,
           y = 0.5,
           size = 2.5) +
  annotate(geom = "text",
           label = "1954: most goals by\n1 country (Hungary, 27)",
           x = 1949,
           y = 5,
           size = 2.5,
           color = "#A80040") +
  annotate(geom = "text",
           label = "1966: first hattrick\nin a World Cup final",
           x = 1958,
           y = 2.4,
           size = 2.5) +
  annotate(geom = "text",
           label = "1978: hardest World\nCup to qualify for",
           x = 1982,
           y = 5.1,
           size = 2.5, 
           color = "#A80040") +
  geom_segment(aes(x = 1978, y = 2.68,
                   xend = 1978, yend = 4.8),
               color = "#A80040")
```

## Question 2

```{r}
q2 <- wcmatches %>%
  pivot_longer(c(home_team, away_team)) %>%
  rename(home_away = name,
         team = value)

```

### Add Continent

#### Making continent lists

```{r}
Europe  <- c('France', "Belgium", 'Yugoslavia', 'Romania', 'Sweden', 'Austria', 'Germany', 'Spain', 'Czechoslovakia', 'Hungary', 'Italy', 'Netherlands', 'Switzerland', 'Poland', 'Norway', 'England', 'Scotland', 'West Germany', 'Turkey', 'Northern Ireland', 'Wales', 'Bulgaria', 'Portugal', 'East Germany', 'Denmark', 'Republic of Ireland', 'Greece', 'Croatia', 'FR Yugoslavia', 'Serbia', 'Slovenia', 'Czech Republic', 'Ukraine', 'Slovakia', 'Iceland', 'Bosnia and Herzegovina') 

Asia <- c('South Korea', 'Soviet Union', 'North Korea', 'Israel', 'Iran', 'Cameroon', 'Kuwait', 'Iraq', 'United Arab Emirates', 'Russia', 'Saudi Arabia', 'Japan', 'China PR', 'Australia', 'New Zealand')

Africa <- c('Egypt', 'Morocco', 'Zaire', 'Tunisia', 'Algeria', 'Nigeria', 'South Africa', 'Senegal', 'Ivory Coast', 'Angola', 'Ghana', 'Togo' )

North_America <- c('Mexico', 'United States', 'Cuba', 'Dutch West Indies', 'Haiti', 'El Salvador', "Honduras", 'Canada', 'Costa Rica', 'Jamaica', 'Trinidad and Tobago', 'Panama')

South_America <- c('Brazil', 'Peru', 'Argentina', 'Chile', 'Bolivia', 'Paraguay', 'Uruguay', 'Colombia','Ecuador')

```

### Make continent variable

```{r}
q2 <- q2 %>%
  mutate(continent =
           case_when(team %in% Europe ~ 'Europe',
                     team %in% Asia ~ 'Asia/Oceania',
                     team %in% South_America ~ 'South America',
                     team %in% North_America ~ 'North America',
                     team %in% Africa ~ 'Africa',
                     TRUE ~ 'Other'))

```

### Early graphs

```{r}
continent_per_year <- q2 %>%
  group_by(year, continent) %>%
  summarize(teams = unique(team)) %>%
  group_by(year, continent) %>%
  summarize(count_per_continent = n())

freq <- continent_per_year %>%
  group_by(year) %>%
  mutate(total = sum(count_per_continent),
         pct = count_per_continent/total) 
```

```{r}
ggplot(freq, aes(x = year, y = pct, color = continent)) + geom_line()
```
### Question 2: Plot 2
We plan to make a segmented frequency bar chart with the rounds ordered on the x axis from beginning to later rounds, filled by continent, and faceted by decade. The purpose of faceting by decade (or every two decades) is we get to see how representation across the world cup stages has changed over time.
```{r}
#| label: q2_plot2_dataprep

q2_2 <- world_cup_total |>
  pivot_longer(
    cols = c(home_team, away_team),
    names_to = "home_away",
    values_to = "team"
  ) |>
  mutate(
    continent = case_when(
      team %in% Africa ~ "Africa",
      team %in% Asia ~ "Asia",
      team %in% Europe ~ "Europe",
      team %in% North_America ~ "North America",
      team %in% South_America ~ "South America",
      TRUE ~ "Other"
    ),
    rounds = case_when(
      str_detect(stage, "Group") ~ "Group",
      stage %in% c("Round of 16") ~ "Round 16",
      stage == "Quarterfinals" ~ "Quarters",
      stage == "Semifinals" ~ "Semis",
      stage == "Final Round" & 
        winning_team == "Sweden" & losing_team == "Spain" ~ "Third",
      stage == "Third place" ~ "Third",
      stage == "Final Round" & 
        winning_team == "Uruguay" & losing_team == "Brazil" ~ "Final",
      stage == "Final" ~ "Final",
      TRUE ~ "Semis"
    ),
    decade = case_when(
      year %in% 1930:1939 ~ "1930s",
      year %in% 1940:1949 ~ "1940s",
      year %in% 1950:1959 ~ "1950s",
      year %in% 1960:1969 ~ "1960s",
      year %in% 1970:1979 ~ "1970s",
      year %in% 1980:1989 ~ "1980s",
      year %in% 1990:1999 ~ "1990s",
      year %in% 2000:2009 ~ "2000s",
      year %in% 2010:2019 ~ "2010s",
      year %in% 2020:2029 ~ "2020s",
    )
  ) |>
  mutate(
    rounds = fct_relevel(rounds, "Group", "Round 16", "Quarters", 
                         "Semis", "Third", "Final")
  )
```



```{r}
#| label: q2_plot2
#| fig-width: 20
#| fig-height: 20

q2_2 |>
  ggplot(aes(x = rounds, fill = continent)) +
    geom_bar(position = "fill") +
    facet_wrap(~decade, nrow = 1) +
    theme_minimal() +
    labs(
      title = "Representation from Continents Across World Cup Rounds",
      subtitle = "By Decade",
      x = "Rounds",
      y = "Proportion",
      fill = "Continent"
    ) +
    theme(axis.text.x = element_text(angle = 90, hjust = 1, vjust = 0.7),
          strip.text.x = element_text(face = "bold"),
          legend.title = element_text(size = 12),
          legend.text = element_text(size = 10)) +
  scale_fill_manual(values = c("#1077C3", "#FEC310", "#49BCE3", "#56042C", "#A80040"))
    
    
```

