---
title: "The Evolution of the World Cup"
subtitle: "STA/ISS 313 - Project 1"
author: "Team Messi"
format: html
editor: visual
execute:
  echo: false
---

## Abstract

(1 paragraph): Project abstract.

```{r}
#| label: load-pkgs
#| message: false
#| warning: false

library(tidyverse)
library(ggplot2)
```

```{r}
#| label: load-data
#| message: false

wcmatches <-
  readr::read_csv(
    'https://raw.githubusercontent.com/rfordatascience/tidytuesday/master/data/2022/2022-11-29/wcmatches.csv'
  )
worldcups <-
  readr::read_csv(
    'https://raw.githubusercontent.com/rfordatascience/tidytuesday/master/data/2022/2022-11-29/worldcups.csv'
  )
penalties <-
  readr::read_csv("data/penalties_stats_aa.csv") #external data from kaggle
```

```{r}
#| label: merge-data

world_cup_total <- wcmatches |>
  left_join(worldcups, by = "year")

world_cup_total <- penalties %>%
  select(-Host) %>%
  rename('year' = "Year") %>%
  left_join(world_cup_total, penalties, by = 'year')
```

```{r}
#| label: new-variables

penalties2022 <- data.frame(2022, "Qatar", 64, 17, 23, 5, 1)
names(penalties2022) <-
  c(
    "Year",
    "Host",
    "MatchesPlayed",
    "PenaltiesScored",
    "PenaltiesAwarded",
    "PenaltiesSaved",
    "PenaltiesMissed"
  )

penaltiesnew <- rbind(penalties, penalties2022)


world_cup_total <- world_cup_total |>
  mutate(
    goalspergame = goals_scored / games,
    attendancepergame = attendance / games,
    gamesperteam = games / teams
  )

penaltiesnew <- penaltiesnew |>
  mutate(
    penaltiespergame = PenaltiesAwarded / MatchesPlayed,
    penaltymakepercentage = PenaltiesScored / PenaltiesAwarded
  )

names(penaltiesnew)[names(penaltiesnew) == "Year"] <- "year"

penaltieswgoalsnew <-
  merge(penaltiesnew, worldcups, by = "year", all.x = TRUE)
penaltieswgoalsnew$goals_scored[is.na(penaltieswgoalsnew$goals_scored)] <-
  172
penaltieswgoalsnew <- penaltieswgoalsnew |>
  mutate(
    propgoalsthatarepens = PenaltiesScored / goals_scored,
    goalspergame = goals_scored / MatchesPlayed
  )
```

------------------------------------------------------------------------

## Introduction

(1-2 paragraphs): Brief introduction to the dataset. You may repeat some of the information about the dataset provided in the introduction to the dataset on the TidyTuesday repository, paraphrasing on your own terms. Imagine that your project is a standalone document and the grader has no prior knowledge of the dataset.

## Question 1: The Effect of New Rules on Goals Scored

### Introduction

Throughout the World Cup's history, many new rules and technologies have been implemented, changing the way soccer is played. This includes the introduction of penalties for tie breaking, VAR to contest calls on the field, increasing the number of teams in each World Cup, and many more. These factors affect how teams play and have forced players to adapt their strategies. In order to assess the impact caused to the overall game, the most straightforward metric to consider is the number of goals scored. Although the score can oversimplify a very complex game, many important decisions are made from it, including which countries make it into the World Cup and ultimately win the tournament. We, as soccer fans, have decided to analyze goals because it is unarguably the most important and entertaining part of the game.

To explore our question, we will be using the `wcmatches` and `worldcups` datasets from TidyTuesday, and merging in external data from Kaggle containing specifics into penalty kicks taken during the World Cups. Specifically, we will be looking at the variables with year, goals per game, penalties awarded and penalties scored, as well as created variables indicating the implementation of a new rule or a notable event. We will be analyzing both the broad concept of total goals scored as well as penalty kicks. Penalties are a very controversial and powerful part of soccer. For perspective, 3 World Cup finals have been decided by penalty shootouts. To see how the game has been affected since the introduction of penalties in 1970, we will be analyzing the number of penalties awarded and scored over time. This, in conjunction with the rules implemented, will give us insight into how penalties have affected scores and how players have adapted to the changing rules.

### Approach

(1-2 paragraphs): Describe what types of plots you are going to make to address your question. For each plot, provide a clear explanation as to why this plot (e.g. boxplot, barplot, histogram, etc.) is best for providing the information you are asking about. The two plots should be of different types, and at least one of the two plots needs to use either color mapping or facets.

For the first plot, we will be making a scatterplot showing the goals scored per game during each World Cup. This will make the goal scoring trends over time visible and allow for our annotations to reveal possible causes in patterns. We will be coloring points based on whether that tournament had a new rule, and the shape of the point will indicate whether a notable event took place during that tournament. We will add text annotations over the plot indicating what the rule or event that happened during a tournament was.

### Analysis

(2-3 code blocks, 2 figures, text/code comments as needed): In this section, provide the code that generates your plots. Use scale functions to provide nice axis labels and guides. You are welcome to use theme functions to customize the appearance of your plot, but you are not required to do so. All plots must be made with **ggplot2**. Do not use base R or lattice plotting functions.

#### Plot 1

```{r}
#| label: q1-plot1-dataprep
q1 <- world_cup_total |>
  add_row(year = 1942,
          goalspergame = 0,
          country = "Germany") |>
  add_row(year = 1946,
          goalspergame = 0,
          country = "Brazil") |>
  mutate(
    new_rule = case_when(year %in% c(1970, 1982, 1998, 2014, 2018) ~ "Yes",
                         TRUE ~ "No"),
    event = case_when(year %in% c(1942, 1946, 1954, 1966, 1978) ~ "Yes",
                      TRUE ~ "No")
  ) |>
  group_by(year, goalspergame)
```

```{r}
#| label: q1-plot1
ggplot(q1, aes(
  x = year,
  y = goalspergame,
  color = new_rule,
  shape = event
)) +
  geom_point(size = 2) +
  scale_x_continuous(breaks = seq(1930, 2018, by = 8)) +
  theme_minimal() +
  scale_color_manual(values = c("#A80040", "#1077C3")) +
  scale_shape_manual(values = c(16, 8)) +
  labs(
    title = "Goals per game have decreased over time",
    subtitle = "For World Cups 1930-2018",
    x = "Year",
    y = "Goals per game",
    color = "New rule",
    shape = "Notable event"
  ) +
  annotate(
    geom = "text",
    label = "1942, 1946: cancelled \ndue to WWII",
    x = 1944,
    y = 0.5,
    size = 2.5,
    color = "#A80040"
  ) +
  annotate(
    geom = "text",
    label = "1954: most goals by\na country (Hungary, 27)",
    x = 1949,
    y = 5,
    size = 2.5,
    color = "#A80040"
  ) +
  annotate(
    geom = "text",
    label = "1966: first hattrick\nin a World Cup final",
    x = 1958,
    y = 2.4,
    size = 2.5,
    color = "#A80040"
  ) +
  annotate(
    geom = "text",
    label = "1978: hardest World\nCup to qualify for",
    x = 1982,
    y = 5.1,
    size = 2.5,
    color = "#A80040"
  ) +
  geom_segment(aes(
    x = 1978,
    y = 2.68,
    xend = 1978,
    yend = 4.8
  ),
  color = "#A80040") +
  annotate(
    geom = "text",
    label = "1970: penalties introduced",
    x = 1970,
    y = 1.6,
    size = 2.5,
    color = "#1077C3"
  ) +
  geom_segment(aes(
    x = 1970,
    y = 3,
    xend = 1970,
    yend = 1.8
  ),
  color = "#1077C3") +
  annotate(
    geom = "text",
    label = "1982: 16 to 24 teams\n1998: 24 to 32 teams",
    x = 1998,
    y = 4,
    size = 2.5,
    color = "#1077C3"
  ) +
  geom_segment(aes(
    x = 1982,
    y = 2.8,
    xend = 1998,
    yend = 3.7
  ),
  color = "#1077C3") +
  geom_segment(aes(
    x = 1998,
    y = 2.7,
    xend = 1998,
    yend = 3.7
  ),
  color = "#1077C3") +
  annotate(
    geom = "text",
    label = "2014: goal line technology\n2018: VAR introduced",
    x = 2006,
    y = 1,
    size = 2.5,
    color = "#1077C3"
  ) +
  geom_segment(aes(
    x = 2014,
    y = 2.7,
    xend = 2010,
    yend = 1.3
  ),
  color = "#1077C3") +
  geom_segment(aes(
    x = 2018,
    y = 2.6,
    xend = 2010,
    yend = 1.3
  ),
  color = "#1077C3")
```

### Discussion

(1-3 paragraphs): In the Discussion section, interpret the results of your analysis. Identify any trends revealed (or not revealed) by the plots. Speculate about why the data looks the way it does.

The overall trend in the scatterplot is the decrease in goals scored per game across the World Cups. After a short 3 tournament long increase, the number of goals scored per game has steadily decreased from about 4 goals to just over 2. The noticeable outliers are 1942 and 1946, which were cancelled due to WWII, and 1954, which was dominated by the Uruguay team who set the record for the most goals scored by one country. The introduction of penalties did not appear to affect goal scoring. The expansion of the tournament from 16 to 24 to 32 teams also did not have a lasting impact other than the 2-tournament downward trend following 1982. It seems that the implementation of technology in arbitrating games has produced the largest effect in decades. Goal line technology, which notifies the referee when the entire ball crosses the goal line, and VAR (video assistant referee) which allows referees to rewatch plays and either uphold or reverse their initial calls on the field, have both increased the number of goals being scored per game. This is because goal line technology allows referees to stop play the moment a true goal is scored, despite limited vision, and VAR has caused more penalty kicks to be called, which frequently result in goals. 

## Question 2: Representation of Non-European and South American Teams in the World Cup

### Introduction

(1-2 paragraphs): Introduction to the question and what parts of the dataset are necessary to answer the question. Also discuss why you're interested in this question.

Back during the conception of the world cup, despite the 'world' name, it was dominated by European and South American teams. The world cup had very little representation from Asia, Africa and Oceania. (add more context).

To explore our question, we will use the `wcmatches` and `worldcups` datasets from TidyTuesday and merge them by the year of the world cup in order to bring over the information for each world cup to each world cup match. To measure representation from Non-European and South American Teams, we created a variable `continent` based off of the countries of the teams with the levels Africa, Asia, Europe, North America, South America, and Other. For our plots, we visualized how the representation of teams from the different continents have changed throughout the World Cup over time.

### Approach

(1-2 paragraphs): Describe what types of plots you are going to make to address your question. For each plot, provide a clear explanation as to why this plot (e.g. boxplot, barplot, histogram, etc.) is best for providing the information you are asking about. The two plots should be of different types, and at least one of the two plots needs to use either color mapping or facets.

For our second plot, we will make a segmented relative frequency barplot to illustrate how the representation from Non-European and South American teams change across the World Cup rounds and over time. Since we want to explore the relative proportions of teams from each continent across the World Cup stages, we thought it was best to use a segmented relative frequency barplot to allow for straightforward and direct comparison across groups. In addition, we chose to look at relative frequencies rather than counts since the number of teams varies for each round of the World Cup. We will order the rounds on the y axis from the beginning round (Group) to the final round (Final) and fill by continent. We will facet by every two decades since we can explore how the representation across rounds of the World Cup change over time and see this trend for all World Cups in history.

### Analysis

(2-3 code blocks, 2 figures, text/code comments as needed): In this section, provide the code that generates your plots. Use scale functions to provide nice axis labels and guides. You are welcome to use theme functions to customize the appearance of your plot, but you are not required to do so. All plots must be made with **ggplot2**. Do not use base R or lattice plotting functions.

```{r}
#| label: q2_plot2_dataprep

Europe  <- c('France', "Belgium", 'Yugoslavia', 'Romania', 'Sweden', 'Austria', 'Germany', 'Spain', 'Czechoslovakia', 'Hungary', 'Italy', 'Netherlands', 'Switzerland', 'Poland', 'Norway', 'England', 'Scotland', 'West Germany', 'Turkey', 'Northern Ireland', 'Wales', 'Bulgaria', 'Portugal', 'East Germany', 'Denmark', 'Republic of Ireland', 'Greece', 'Croatia', 'FR Yugoslavia', 'Serbia', 'Slovenia', 'Czech Republic', 'Ukraine', 'Slovakia', 'Iceland', 'Bosnia and Herzegovina') 

Asia <- c('South Korea', 'Soviet Union', 'North Korea', 'Israel', 'Iran', 'Cameroon', 'Kuwait', 'Iraq', 'United Arab Emirates', 'Russia', 'Saudi Arabia', 'Japan', 'China PR', 'Australia', 'New Zealand')

Africa <- c('Egypt', 'Morocco', 'Zaire', 'Tunisia', 'Algeria', 'Nigeria', 'South Africa', 'Senegal', 'Ivory Coast', 'Angola', 'Ghana', 'Togo' )

North_America <- c('Mexico', 'United States', 'Cuba', 'Dutch West Indies', 'Haiti', 'El Salvador', "Honduras", 'Canada', 'Costa Rica', 'Jamaica', 'Trinidad and Tobago', 'Panama')

South_America <- c('Brazil', 'Peru', 'Argentina', 'Chile', 'Bolivia', 'Paraguay', 'Uruguay', 'Colombia','Ecuador')

q2_2 <- world_cup_total |>
  pivot_longer(
    cols = c(home_team, away_team),
    names_to = "home_away",
    values_to = "team"
  ) |>
  mutate(
    continent = case_when(
      team %in% Africa ~ "Africa",
      team %in% Asia ~ "Asia",
      team %in% North_America ~ "North America",
      team %in% South_America ~ "South America",
      team %in% Europe ~ "Europe",
      TRUE ~ "Other"
    ),
    rounds = case_when(
      str_detect(stage, "Group") ~ "Group",
      stage %in% c("Round of 16") ~ "Round 16",
      stage == "Quarterfinals" ~ "Quarters",
      stage == "Semifinals" ~ "Semis",
      stage == "Final Round" &
        winning_team == "Sweden" & losing_team == "Spain" ~ "Third",
      stage == "Third place" ~ "Third",
      stage == "Final Round" &
        winning_team == "Uruguay" &
        losing_team == "Brazil" ~ "Final",
      stage == "Final" ~ "Final",
      TRUE ~ "Semis"
    ),
    # changed to be 20 years
    decade = case_when(
      year %in% 1930:1949 ~ "1930s/40s",
      #year %in% 1940:1949 ~ "1940s",
      year %in% 1950:1969 ~ "1950s/60s",
      #year %in% 1960:1969 ~ "1960s",
      year %in% 1970:1989 ~ "1970s/80s",
      #year %in% 1980:1989 ~ "1980s",
      year %in% 1990:2009 ~ "1990/00s",
      #year %in% 2000:2009 ~ "2000s",
      year %in% 2010:2029 ~ "2010s/20s"
      #year %in% 2020:2029 ~ "2020s",
    )
  )
```

```{r}
#| label: q2-plot2
#| warning: false

# Exclude "Third" from the levels of the factor variable "rounds"
q2_2_no_third <- q2_2 %>% filter(rounds != "Third")

# Reorder the factor levels of the "continent" variable
q2_2_no_third$continent <- fct_relevel(
  q2_2_no_third$continent,
  "Other",
  "Africa",
  "North America",
  "Asia",
  "South America",
  "Europe"
)

# Create the stacked bar plot
q2_2_no_third |>
  mutate(rounds = fct_relevel(rounds, "Final", "Semis", "Quarters", "Round 16", "Group")) |>
  ggplot(aes(x = rounds, fill = continent)) +
  geom_bar(position = "fill") +
  # facet_wrap(~decade, ncol = 1) +
  facet_grid(decade ~ .) +
  theme_minimal() +
  coord_flip() +
  labs(title = "European and South American Teams Dominating Later Rounds",
       x = "Rounds of the World Cup",
       y = "Proportion",
       fill = "Continent") +
  theme(
    axis.text.x = element_text(vjust = 0.7, face = "bold"),
    strip.text.y = element_text(angle = 360, face = "bold"),
    legend.title = element_text(size = 12),
    legend.text = element_text(size = 10),
    axis.title.y = element_text(margin = margin(
      t = 0,
      r = 20,
      b = 0,
      l = 0
    )),
    axis.title.x = element_text(margin = margin(
      t = 15,
      r = 0,
      b = 0,
      l = 0
    ))
  ) +
  scale_fill_manual(values = c("#e29578", "#56042C", "#F2CC8F", "#006d77", "#83c5be")) 
```

### Discussion

(1-3 paragraphs): In the Discussion section, interpret the results of your analysis. Identify any trends revealed (or not revealed) by the plots. Speculate about why the data looks the way it does.
